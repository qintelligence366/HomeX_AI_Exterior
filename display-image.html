<!DOCTYPE html>
<html>
<body>
    <canvas id="canvas" style="border: 1px solid black;"></canvas>
    <button id="confirmButton" style="display: none;">确认框选 / Confirm Selection</button>
    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        let image = new Image();
        let points = [];
        const confirmButton = document.getElementById("confirmButton");

        const params = new URLSearchParams(window.location.search);
        let imageUrl = params.get("imageUrl") || "https://via.placeholder.com/300";
        if (imageUrl && !imageUrl.includes("via.placeholder")) {
            if (!imageUrl.includes("auto=format")) {
                imageUrl += "?auto=format&q=20";
            }
        }
        image.src = imageUrl;

        image.onload = () => {
            const maxWidth = 345;
            const maxHeight = 250;
            const scale = Math.min(maxWidth / image.width, maxHeight / image.height);
            const newWidth = image.width * scale;
            const newHeight = image.height * scale;

            canvas.width = newWidth;
            canvas.height = newHeight;
            ctx.drawImage(image, 0, 0, newWidth, newHeight);

            console.log("Canvas initialized:", canvas.width, canvas.height);
        };

        function getDistance(p1, p2) {
            return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
        }

        function handleInteraction(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.type.includes("touch") ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.type.includes("touch") ? e.touches[0].clientY : e.clientY) - rect.top;

            points.push({ x: x, y: y });

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

            points.forEach(point => {
                ctx.beginPath();
                ctx.arc(point.x, point.y, 1, 0, 2 * Math.PI);
                ctx.fillStyle = "red";
                ctx.fill();
            });

            if (points.length > 1) {
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                if (points.length >= 4) {
                    const firstPoint = points[0];
                    const lastPoint = points[points.length - 1];
                    const distanceThreshold = 20;
                    if (getDistance(firstPoint, lastPoint) < distanceThreshold) {
                        ctx.closePath();
                        ctx.strokeStyle = "lightblue";
                        ctx.stroke();
                        confirmButton.style.display = "block"; // 显示确认按钮 / Show confirm button
                    }
                }
            }

            console.log("Clicked at:", x, y);
        }

        canvas.addEventListener("click", handleInteraction);
        canvas.addEventListener("touchstart", handleInteraction);

        confirmButton.addEventListener("click", () => {
            console.log("Selection confirmed with points:", points);
            confirmButton.style.display = "none"; // 隐藏确认按钮 / Hide confirm button
        });

        console.log("Image URL:", imageUrl);
    </script>
</body>
</html>
